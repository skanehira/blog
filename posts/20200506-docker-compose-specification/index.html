<!doctype html><html lang=ja-jp><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="docker-composeの仕様であるCompose Specificationについて"><meta itemprop=description content="初めに こんにちわ。 ゴリラです。 先日、Docker社がdocker-composeが提供していた機能の仕様をCompose Specificat"><meta itemprop=datePublished content="2020-05-06T00:00:00+00:00"><meta itemprop=dateModified content="2020-05-06T00:00:00+00:00"><meta itemprop=wordCount content="1628"><meta itemprop=keywords content="docker-compose,Docker,"><meta property="og:title" content="docker-composeの仕様であるCompose Specificationについて"><meta property="og:description" content="初めに こんにちわ。 ゴリラです。 先日、Docker社がdocker-composeが提供していた機能の仕様をCompose Specificat"><meta property="og:type" content="article"><meta property="og:url" content="https://skanehira.github.io/blog/posts/20200506-docker-compose-specification/"><meta property="article:published_time" content="2020-05-06T00:00:00+00:00"><meta property="article:modified_time" content="2020-05-06T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="docker-composeの仕様であるCompose Specificationについて"><meta name=twitter:description content="初めに こんにちわ。 ゴリラです。 先日、Docker社がdocker-composeが提供していた機能の仕様をCompose Specificat"><link rel=apple-touch-icon sizes=180x180 href=/blog/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/blog/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/blog/favicon-16x16.png><link rel=manifest href=/blog/site.webmanifest><link rel=mask-icon href=/blog/safari-pinned-tab.svg color><link rel="shortcut icon" href=/blog/favicon.ico><title>docker-composeの仕様であるCompose Specificationについて</title><link rel=stylesheet href=https://skanehira.github.io/blog/css/style.min.eac77496566fd7d5768fd650ddb0b2b181ca6a2d7c5fdd6fe6b8ba4bf47e566f.css integrity="sha256-6sd0llZv19V2j9ZQ3bCysYHKai18X91v5ri6S/R+Vm8=" crossorigin=anonymous></head><body id=page><header id=site-header class="animated slideInUp"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://skanehira.github.io/blog/>ゴリラ@転生したら人間だった件</a></div><nav class="site-nav hide-in-mobile"><a href=https://skanehira.github.io/blog/aboutme>About me</a>
<a href=https://skanehira.github.io/blog/posts/>Posts</a>
<a href=https://skanehira.github.io/blog/tags/>Tags</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href=https://twitter.com/gorilla0513 target=_blank rel="noopener me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=https://github.com/skanehira target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></span><button id=menu-btn class=hdr-btn><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://skanehira.github.io/blog/aboutme>About me</a></li><li><a href=https://skanehira.github.io/blog/posts/>Posts</a></li><li><a href=https://skanehira.github.io/blog/tags/>Tags</a></li></ul></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-meta><span>2020/05/06</span></div><h1>docker-composeの仕様であるCompose Specificationについて</h1></header><div class=content><h2 id=初めに>初めに<a href=#初めに class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>こんにちわ。
ゴリラです。</p><p>先日、Docker社が<code>docker-compose</code>が提供していた機能の仕様を<a href=https://compose-spec.io/>Compose Specification</a>としてオープンな仕様にしていく発表がありました。</p><p><code>docker-compose</code>自体はオープンソースとして<a href=https://github.com/docker/compose>GitHub.ocm/docker/compose</a>に公開されてはいますが、
具体的な仕様については定まっていなかったので、今後はそれらの機能の仕様を標準化をしていくそうです。</p><p>現時点決まっている仕様は<a href=https://github.com/compose-spec/compose-spec>compose-spec/compose-spec</a>で公開されています。
仕様に沿ってリファレンス実装である<a href=https://github.com/compose-spec/compose-ref>compose-ref</a>も公開されています。</p><p>本記事は<code>compose-ref</code>を試してわかったことを共有するのが目的です。
気になる方はぜひ最後まで読んでみてください。</p><h2 id=compose-refのインストール><code>compose-ref</code>のインストール<a href=#compose-refのインストール class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p><code>compose-ref</code>はGoで書かれていますので、Goを予め用意して次の手順でインストールします。</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>$ git clone https://github.com/compose-spec/compose-ref.git
$ <span class=nb>cd</span> compose-ref
$ go install
$ compose-ref

 .---.
<span class=o>(</span>     <span class=o>)</span>
 <span class=o>)</span>@ @<span class=o>(</span>
//<span class=o>||</span><span class=p>|</span><span class=se>\\</span>

NAME:
   compose-ref - Reference Compose Specification implementation

USAGE:
   compose-ref <span class=o>[</span>global options<span class=o>]</span> <span class=nb>command</span> <span class=o>[</span><span class=nb>command</span> options<span class=o>]</span> <span class=o>[</span>arguments...<span class=o>]</span>

COMMANDS:
   up       Create and start application services
   down     Stop services created by <span class=sb>`</span>up<span class=sb>`</span>
   help, h  Shows a list of commands or <span class=nb>help</span> <span class=k>for</span> one <span class=nb>command</span>

GLOBAL OPTIONS:
   --file FILE, -f FILE          Load Compose file FILE <span class=o>(</span>default: <span class=s2>&#34;compose.yaml&#34;</span><span class=o>)</span>
   --project-name NAME, -n NAME  Set project name NAME <span class=o>(</span>default: Compose file<span class=err>&#39;</span>s folder name<span class=o>)</span>
   --help, -h                    show <span class=nb>help</span> <span class=o>(</span>default: <span class=nb>false</span><span class=o>)</span>
</code></pre></div><h2 id=compose-fileについて><code>Compose file</code>について<a href=#compose-fileについて class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p><code>docker-compose</code>ではデフォルトで<code>docker-compose.yaml</code>もしくは<code>docker-compose.yml</code>を読み込むようになっていますが、
本仕様では<code>compose.yaml</code>もしくは<code>compose.yml</code>をデフォルトで読み込みます。</p><p>ただ、後方互換を維持するために<code>docker-compose.yaml</code>もサポートするとのことです。
これについては<a href=https://github.com/compose-spec/compose-spec/blob/master/spec.md#compose-file>こちら</a>に記述されています。</p><h2 id=動作確認>動作確認<a href=#動作確認 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>現時点では<code>up</code>と<code>down</code>しか実装されていませんが、最低限コンテナの作成と削除はできますので、試してみましょう。
まず次の<code>compose.yaml</code>を用意します。</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>$ cat compose.yaml
version: <span class=s1>&#39;3.7&#39;</span>

services:
   wordpress:
     image: wordpress:latest
     container_name: wordpress
     depends_on:
       - db
     ports:
       - <span class=s2>&#34;8000:80&#34;</span>
     environment:
       WORDPRESS_DB_HOST: db:3306
       WORDPRESS_DB_USER: wordpress
       WORDPRESS_DB_PASSWORD: wordpress
       WORDPRESS_DB_NAME: wordpress
     restart: always
   db:
     image: mysql:5.7
     container_name: wordpress_db
     restart: always
     environment:
       MYSQL_ROOT_PASSWORD: root
       MYSQL_DATABASE: wordpress
       MYSQL_USER: wordpress
       MYSQL_PASSWORD: wordpress
</code></pre></div><p>用意できたら次にイメージをpullしてきます。<code>docker-compose</code>ではイメージがなければ自動でpullしてくれますが、残念ながらこのリファレンス実装では自動でイメージをpullする実装になっていないです。
イメージがないと次のように<code>No suc image: wordpress:latest</code>というメッセージが出ます。</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>$ compose-ref up

 .---.
<span class=o>(</span>     <span class=o>)</span>
 <span class=o>)</span>@ @<span class=o>(</span>
//<span class=o>||</span><span class=p>|</span><span class=se>\\</span>

Creating container <span class=k>for</span> service db ... 4f50328e447116aebe091c150607eb5dee1bee83b01e622785c8141c4dbf5a09
Creating container <span class=k>for</span> service wordpress ... 2020/05/06 15:35:05 Error response from daemon: No such image: wordpress:latest
</code></pre></div><p>イメージを用意できたら<code>up</code>しましょう。</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>$ compose-ref up

 .---.
<span class=o>(</span>     <span class=o>)</span>
 <span class=o>)</span>@ @<span class=o>(</span>
//<span class=o>||</span><span class=p>|</span><span class=se>\\</span>

Creating container <span class=k>for</span> service wordpress ... 12cee476290011aae97abe9982dc43be164449adade2cdb55467828d92362cf6
Stopping containers <span class=k>for</span> service hello-world ... 3135cb302bba563ee4da9c54428d5083d45487727b41c2a28f7c4abbb2273aea

$ docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                          PORTS                  NAMES
12cee4762900        wordpress:latest    <span class=s2>&#34;docker-entrypoint.s…&#34;</span>   <span class=m>47</span> seconds ago      Up <span class=m>46</span> seconds                   0.0.0.0:8000-&gt;80/tcp   blissful_edison
4f50328e4471        mysql:5.7           <span class=s2>&#34;docker-entrypoint.s…&#34;</span>   <span class=m>4</span> minutes ago       Restarting <span class=o>(</span>1<span class=o>)</span> <span class=m>11</span> seconds ago                          inspiring_blackwell
</code></pre></div><p>現時点ではまだ、<code>container_name</code>は適用されないようですね。
ちなみに、<code>compose-ref</code>で作られたコンテナは<code>Config.Labels</code>にいくつかラベルが貼られます。確認してみましょう。</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>$ docker inspect -f <span class=s2>&#34;{{ .Config.Labels }}&#34;</span> blissful_edison inspiring_blackwell
map<span class=o>[</span>io.compose-spec.config:container_name: wordpress
depends_on:
- db
environment:
  WORDPRESS_DB_HOST: db:3306
  WORDPRESS_DB_NAME: wordpress
  WORDPRESS_DB_PASSWORD: wordpress
  WORDPRESS_DB_USER: wordpress
image: wordpress:latest
ports:
- mode: ingress
  target: <span class=m>80</span>
  published: <span class=m>8000</span>
  protocol: tcp
restart: always
 io.compose-spec.project:compose-ref io.compose-spec.service:wordpress<span class=o>]</span>
map<span class=o>[</span>io.compose-spec.config:container_name: wordpress_db
environment:
  MYSQL_DATABASE: wordpress
  MYSQL_PASSWORD: wordpress
  MYSQL_ROOT_PASSWORD: root
  MYSQL_USER: wordpress
image: mysql:5.7
restart: always
 io.compose-spec.project:compose-ref io.compose-spec.service:db<span class=o>]</span>
</code></pre></div><p>ちゃんとありますね。</p><p>次に<code>down</code>の動作を見てみましょう。</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>compose-ref down

 .---.
<span class=o>(</span>     <span class=o>)</span>
 <span class=o>)</span>@ @<span class=o>(</span>
//<span class=o>||</span><span class=p>|</span><span class=se>\\</span>

Stopping containers <span class=k>for</span> service wordpress ... 12cee476290011aae97abe9982dc43be164449adade2cdb55467828d92362cf6
Stopping containers <span class=k>for</span> service db ... 4f50328e447116aebe091c150607eb5dee1bee83b01e622785c8141c4dbf5a09
Deleting network compose-ref-default ... compose-ref-default

$ docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
</code></pre></div><p>ちゃんと消えてますね。ネットワークまで消してくれています。</p><p>以上、簡単ではありますがリファレンス実装の動作確認です。まだ実装途中ですが仕様を流し読みした感じではこれまでと大きく変わることはなさそうです。</p><h2 id=おまけ>おまけ<a href=#おまけ class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p><code>compose-ref up</code>するとき、イメージがなければpullしてくれないのは不便なのでPRを投げました</p><p><a href=https://github.com/compose-spec/compose-ref/pull/46>https://github.com/compose-spec/compose-ref/pull/46</a></p><h2 id=まとめ>まとめ<a href=#まとめ class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p><code>Compose Specification</code>で仕様がある程度定まったら色々と面白くなりそうだなというのが個人的な感想です。
せっかくなので、この仕様を元に実用的なCLIを作ろうと思っています。できあたらそのうち公開します。</p></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://skanehira.github.io/blog/tags/docker-compose>docker-compose</a></span><span class=tag><a href=https://skanehira.github.io/blog/tags/Docker>Docker</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2020/05/06 00:00</p></footer></article><div class="post-nav thin"><a class=next-post href=https://skanehira.github.io/blog/posts/20200523-mcp/><span class=post-nav-label><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>&nbsp;</span><br><span>エディタで複数のファイルを簡単にコピーするコマンドをGoで作った</span></a>
<a class=prev-post href=https://skanehira.github.io/blog/posts/20200506-docker-api-filters/><span class=post-nav-label>&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>dockerのイメージ一覧APIのfiltersパラメータについての調査</span></a></div><div id=comments class=thin></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2021 <a href=https://skanehira.github.io/blog/>skanehira</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://skanehira.github.io/blog/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://skanehira.github.io/blog/js/bundle.min.4a9a0ac3d2217822c7865b4161e6c2a71de1d70492264337755427898dd718f6.js integrity="sha256-SpoKw9IheCLHhltBYebCpx3h1wSSJkM3dVQniY3XGPY=" crossorigin=anonymous></script></body></html>