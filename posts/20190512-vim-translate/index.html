<!doctype html><html lang=ja-jp><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="翻訳プラグイン作りました"><meta itemprop=description content="こんにちわ。 ゴリラ.vimを運営しているゴリラです。 みなさんはプラグイン使っていますか？ ぼくはプラグイン使っていますが、全然作ったことがない"><meta itemprop=datePublished content="2019-05-12T00:00:00+00:00"><meta itemprop=dateModified content="2019-05-12T00:00:00+00:00"><meta itemprop=wordCount content="2848"><meta itemprop=keywords content="Vim,"><meta property="og:title" content="翻訳プラグイン作りました"><meta property="og:description" content="こんにちわ。 ゴリラ.vimを運営しているゴリラです。 みなさんはプラグイン使っていますか？ ぼくはプラグイン使っていますが、全然作ったことがない"><meta property="og:type" content="article"><meta property="og:url" content="https://skanehira.github.io/blog/posts/20190512-vim-translate/"><meta property="article:published_time" content="2019-05-12T00:00:00+00:00"><meta property="article:modified_time" content="2019-05-12T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="翻訳プラグイン作りました"><meta name=twitter:description content="こんにちわ。 ゴリラ.vimを運営しているゴリラです。 みなさんはプラグイン使っていますか？ ぼくはプラグイン使っていますが、全然作ったことがない"><link rel=apple-touch-icon sizes=180x180 href=/blog/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/blog/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/blog/favicon-16x16.png><link rel=manifest href=/blog/site.webmanifest><link rel=mask-icon href=/blog/safari-pinned-tab.svg color><link rel="shortcut icon" href=/blog/favicon.ico><title>翻訳プラグイン作りました</title><link rel=stylesheet href=https://skanehira.github.io/blog/css/style.min.eac77496566fd7d5768fd650ddb0b2b181ca6a2d7c5fdd6fe6b8ba4bf47e566f.css integrity="sha256-6sd0llZv19V2j9ZQ3bCysYHKai18X91v5ri6S/R+Vm8=" crossorigin=anonymous></head><body id=page><header id=site-header class="animated slideInUp"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://skanehira.github.io/blog/>ゴリラ@転生したら人間だった件</a></div><nav class="site-nav hide-in-mobile"><a href=https://skanehira.github.io/blog/>Home</a>
<a href=https://skanehira.github.io/blog/posts/>Posts</a></nav></div><div class="hdr-right hdr-icons"><button id=toc-btn class="hdr-btn desktop-only-ib"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-list"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3" y2="6"/><line x1="3" y1="12" x2="3" y2="12"/><line x1="3" y1="18" x2="3" y2="18"/></svg></button><span class="hdr-social hide-in-mobile"><a href=https://twitter.com/gorilla0513 target=_blank rel="noopener me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=https://github.com/skanehira target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></span><button id=menu-btn class=hdr-btn><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://skanehira.github.io/blog/>Home</a></li><li><a href=https://skanehira.github.io/blog/posts/>Posts</a></li></ul></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-meta><span>2019/05/12</span></div><h1>翻訳プラグイン作りました</h1></header><div class=content><p>こんにちわ。
<a href=https://gorillavim.connpass.com/>ゴリラ.vim</a>を運営しているゴリラです。</p><p>みなさんはプラグイン使っていますか？
ぼくはプラグイン使っていますが、全然作ったことがないので初めて実用的なものを作りました。</p><p>普段OSSのソースを読んだり、作ったOSSのREADMEを英語で書いたりするのですが、
英語力がないため都度ブラウザを開いてGoogle翻訳を使ってはVimに戻る日々でした。</p><p>画面の切り替えは時間ロスなのでVim上で翻訳できるプラグインを作りました。</p><p>このプラグインがあればVimは翻訳エディタへと生まれ変わります。
どうぞお試して下さい。</p><p><a href=https://github.com/skanehira/translate.vim><img src=https://github-link-card.s3.ap-northeast-1.amazonaws.com/skanehira/translate.vim.png width=460px></a></p><h2 id=機能>機能<a href=#機能 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>状況に応じて、次のことができます。</p><ol><li>動的に翻訳する</li><li>選択した範囲を翻訳する</li><li>現在行翻訳する</li></ol><p>どれも多分よく使うと思います。
設定項目は次になります。</p><div class=highlight><pre class=chroma><code class=language-vim data-lang=vim><span class=c>&#34; 翻訳元言語</span><span class=err>
</span><span class=err></span><span class=k>let</span> <span class=nx>g</span>:<span class=nx>translate_source</span> <span class=p>=</span> <span class=s2>&#34;en&#34;</span><span class=err>
</span><span class=err></span><span class=c>&#34; 翻訳先言語</span><span class=err>
</span><span class=err></span><span class=k>let</span> <span class=nx>g</span>:<span class=nx>translate_target</span> <span class=p>=</span> <span class=s2>&#34;ja&#34;</span><span class=err>
</span><span class=err></span><span class=c>&#34; 翻訳結果ウィンドウのサイズ</span><span class=err>
</span><span class=err></span><span class=k>let</span> <span class=nx>g</span>:<span class=nx>translate_winsize</span> <span class=p>=</span> <span class=m>10</span><span class=err>
</span></code></pre></div><h3 id=動的に翻訳する>動的に翻訳する<a href=#動的に翻訳する class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p><img src=https://i.imgur.com/ezLCrSG.gif alt></p><p><code>:AutoTranslateModeToggle</code>で動的に翻訳するモードに切り替えます。
再度実行するとモードがOFFにになります。
自動翻訳モードになると、バッファ上の文字が全て翻訳されます。</p><p>翻訳の契機は<code>&lt;CR></code>になっていて、改行するとその行を翻訳します。</p><p><code>:AutoTranslateModeToggle!</code>では、翻訳元と翻訳先の言語が入れ替わった状態でモードを切り替ります。</p><p>ぼくは自動翻訳READMEを書く時に日本語が変になっていないかを確認するときに使います。
控えめに言って、便利です。</p><h3 id=選択した範囲を翻訳する>選択した範囲を翻訳する<a href=#選択した範囲を翻訳する class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p><img src=https://i.imgur.com/maB2QXI.gif alt></p><p>ビジュアルモードで選択した状態で<code>:Translate</code>で翻訳できます。
こちらはソースのコメントを読む時などに便利です。</p><p>ちなみに、<code>:Translate!</code>で翻訳元と翻訳先の言語がに入れ替わります。
控えめに言って、便利です。</p><h2 id=仕組み>仕組み<a href=#仕組み class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><h3 id=翻訳api>翻訳API<a href=#翻訳api class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>一番大事な翻訳処理ですが、
GAS<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>の<a href=https://developers.google.com/apps-script/reference/language/language-app>LanguageApp</a>クラスを使用しています。</p><p>GASではプロジェクトをウェブアプリとして公開することができます。
HTTPリクエストは<code>doPost(e)</code>、<code>doGet(e)</code>を用意することで受け取りことが可能です。</p><p>HTTPリクエストJSONを取得し、それをもとにLanguageAppクラスで翻訳してその結果を返却します。
こうすることで簡易の翻訳APIを作ることができます。</p><p>ちなみに、次が翻訳APIの処理になります。</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=kd>function</span> <span class=nx>doPost</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
  <span class=kd>var</span> <span class=nx>p</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nx>postData</span><span class=p>.</span><span class=nx>getDataAsString</span><span class=p>());</span>
  <span class=k>if</span> <span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>text</span> <span class=o>==</span> <span class=s2>&#34;&#34;</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nx>ContentService</span><span class=p>.</span><span class=nx>createTextOutput</span><span class=p>(</span><span class=s2>&#34;text is empty&#34;</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>source</span> <span class=o>==</span> <span class=s2>&#34;&#34;</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nx>ContentService</span><span class=p>.</span><span class=nx>createTextOutput</span><span class=p>(</span><span class=s2>&#34;source is empty&#34;</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>target</span> <span class=o>==</span> <span class=s2>&#34;&#34;</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nx>ContentService</span><span class=p>.</span><span class=nx>createTextOutput</span><span class=p>(</span><span class=s2>&#34;target is empty&#34;</span><span class=p>);</span>
  <span class=p>}</span>
  
  <span class=kd>var</span> <span class=nx>translatedText</span> <span class=o>=</span> <span class=nx>LanguageApp</span><span class=p>.</span><span class=nx>translate</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>text</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>source</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>target</span><span class=p>);</span>
  <span class=k>return</span> <span class=nx>ContentService</span><span class=p>.</span><span class=nx>createTextOutput</span><span class=p>(</span><span class=nx>translatedText</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>ちなみに、プラグインが使用しているAPIのEndpointは次になります。</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>https://script.google.com/macros/s/AKfycbywwDmlmQrNPYoxL90NCZYjoEzuzRcnRuUmFCPzEqG7VdWBAhU/exec
</code></pre></div><p>次のようにcurlコマンドでJSONをPOSTすれば翻訳結果が返ってきます。
<a href=https://github.com/skanehira/gjo>gjo</a>はゴリラ製OSSの一つで<code>key=value</code>形式で引数を渡すことで簡単にJSON文字列を生成できます。</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ curl -L https://script.google.com/macros/s/AKfycbywwDmlmQrNPYoxL90NCZYjoEzuzRcnRuUmFCPzEqG7VdWBAhU/exec -d <span class=k>$(</span>gjo <span class=nv>text</span><span class=o>=</span><span class=s2>&#34;my name is gorilla&#34;</span> <span class=nv>source</span><span class=o>=</span>en <span class=nv>target</span><span class=o>=</span>ja<span class=k>)</span>
私の名前はゴリラです⏎
</code></pre></div><h3 id=翻訳cli>翻訳CLI<a href=#翻訳cli class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>翻訳APIがあればそれに本文と翻訳する言語のオプションを渡すだけです。
もともとVim scriptのみでHTTP通信を行い、翻訳するつもりでしましたが、
Goの勉強もしたいためCLIを作りそれをVimで呼び出す仕組みにしました。</p><p>CLIに関してはGoの標準パッケージ<code>net/http</code>を使用して、
引数で渡したオプションと本文をJSONに変換し翻訳APIをコールしています。</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>type</span> <span class=nx>post</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>Text</span>   <span class=kt>string</span> <span class=s>`json:&#34;text&#34;`</span>
	<span class=nx>Source</span> <span class=kt>string</span> <span class=s>`json:&#34;source&#34;`</span>
	<span class=nx>Target</span> <span class=kt>string</span> <span class=s>`json:&#34;target&#34;`</span>
<span class=p>}</span>

<span class=c1>// translate language
</span><span class=c1></span><span class=kd>func</span> <span class=nf>translate</span><span class=p>(</span><span class=nx>text</span><span class=p>,</span> <span class=nx>source</span><span class=p>,</span> <span class=nx>target</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>postData</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>post</span><span class=p>{</span><span class=nx>text</span><span class=p>,</span> <span class=nx>source</span><span class=p>,</span> <span class=nx>target</span><span class=p>})</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>

	<span class=nx>req</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>NewRequest</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>MethodPost</span><span class=p>,</span> <span class=o>*</span><span class=nx>endpoint</span><span class=p>,</span> <span class=nx>bytes</span><span class=p>.</span><span class=nf>NewBuffer</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>postData</span><span class=p>)))</span>

	<span class=nx>req</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;Content-Type&#34;</span><span class=p>,</span> <span class=s>&#34;application/json&#34;</span><span class=p>)</span>

	<span class=nx>client</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>http</span><span class=p>.</span><span class=nx>Client</span><span class=p>{}</span>
	<span class=nx>resp</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>Do</span><span class=p>(</span><span class=nx>req</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>
	<span class=k>defer</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>

	<span class=nx>body</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
	<span class=p>}</span>

	<span class=k>return</span> <span class=nb>string</span><span class=p>(</span><span class=nx>body</span><span class=p>),</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><h3 id=vimプラグイン>Vimプラグイン<a href=#vimプラグイン class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>Vimのプラグインは<code>autoload</code>と<code>plugin</code>ディレクトリがあります。
それぞれの違いは次になります。</p><table><thead><tr><th>ディレクトリ</th><th>説明</th></tr></thead><tbody><tr><td>autoload</td><td>使用するときに初めて読み込まれるスクリプトファイルを置く</td></tr><tr><td>plugin</td><td>Vim起動時に読み込まれるスクリプトファイルを置く</td></tr></tbody></table><p>基本的に読み込みに時間がかかるスクリプトは<code>autoload</code>に置きますが、今回はとくに重たい処理をするわけではないので<code>plugin</code>ディレクトリのみで物足ります。</p><p>プラグインのメイン処理についてざっくり紹介していきます。</p><h4 id=cli実行コマンド生成>CLI実行コマンド生成<a href=#cli実行コマンド生成 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><p>まずCLIの実行コマンドを生成します。
<code>ban</code>は<code>!</code>のことを指していて<code>!</code>のときは翻訳元・先の設定を逆転させています。</p><p><code>let source_ = get(g:, "translate_source", "en")</code>ではグローバルスコープの設定値がなければ、デフォルト値をを取得するようにしています。
<code>target</code>の処理も同様になります。</p><div class=highlight><pre class=chroma><code class=language-vim data-lang=vim><span class=c>&#34; create gtran command with text and bang</span><span class=err>
</span><span class=err></span><span class=k>function</span><span class=p>!</span> <span class=nx>s</span>:<span class=nx>create_cmd</span><span class=p>(</span><span class=nx>text</span><span class=p>,</span> <span class=nx>bang</span><span class=p>)</span> <span class=nx>abort</span><span class=err>
</span><span class=err></span>    <span class=k>if</span> <span class=nx>a</span>:<span class=nx>text</span> <span class=p>==</span> <span class=s2>&#34;&#34;</span><span class=err>
</span><span class=err></span>        <span class=nx>return</span><span class=err>
</span><span class=err></span>    <span class=k>endif</span><span class=err>
</span><span class=err>
</span><span class=err></span>    <span class=k>let</span> <span class=nx>source_</span> <span class=p>=</span> <span class=nx>get</span><span class=p>(</span><span class=nx>g</span>:<span class=p>,</span> <span class=s2>&#34;translate_source&#34;</span><span class=p>,</span> <span class=s2>&#34;en&#34;</span><span class=p>)</span><span class=err>
</span><span class=err></span>    <span class=k>let</span> <span class=nx>target</span> <span class=p>=</span> <span class=nx>get</span><span class=p>(</span><span class=nx>g</span>:<span class=p>,</span> <span class=s2>&#34;translate_target&#34;</span><span class=p>,</span> <span class=s2>&#34;ja&#34;</span><span class=p>)</span><span class=err>
</span><span class=err>
</span><span class=err></span>    <span class=k>let</span> <span class=nx>cmd</span> <span class=p>=</span> [<span class=s2>&#34;gtran&#34;</span><span class=p>,</span> <span class=s2>&#34;-text=&#34;</span>.<span class=nx>a</span>:<span class=nx>text</span><span class=p>,</span> <span class=s2>&#34;-source=&#34;</span>.<span class=nx>source_</span><span class=p>,</span> <span class=s2>&#34;-target=&#34;</span>.<span class=nx>target</span>]<span class=err>
</span><span class=err></span>    <span class=k>if</span> <span class=nx>a</span>:<span class=nx>bang</span> <span class=p>==</span> <span class=s1>&#39;!&#39;</span><span class=err>
</span><span class=err></span>        <span class=k>let</span> <span class=nx>cmd</span> <span class=p>=</span> [<span class=s2>&#34;gtran&#34;</span><span class=p>,</span> <span class=s2>&#34;-text=&#34;</span>.<span class=nx>a</span>:<span class=nx>text</span><span class=p>,</span> <span class=s2>&#34;-source=&#34;</span>.<span class=nx>target</span><span class=p>,</span> <span class=s2>&#34;-target=&#34;</span>.<span class=nx>source_</span>]<span class=err>
</span><span class=err></span>    <span class=k>endif</span><span class=err>
</span><span class=err></span>    <span class=nx>return</span> <span class=nx>cmd</span><span class=err>
</span><span class=err></span><span class=k>endfunction</span><span class=err>
</span></code></pre></div><h4 id=コマンド実行>コマンド実行<a href=#コマンド実行 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><p><code>job_start</code>で外部コマンドを非同期で実行します。
Vimでは外部コマンドを実行する方法として、<code>system()</code>と<code>systemlist()</code>がありますが、
これらは実行が完了するまでVimを操作できないので、翻訳を待ちながらその間に作業をしたいため<code>job_start()</code>にしました。</p><p><code>job_start</code>ではオプションを指定することができます。</p><p><code>callback</code>で指定したcallback関数ではコマンド実行結果の出力を取得します。
callback関数では出力の行数分呼ばれるので、<code>s:result</code>変数に結果を格納していきます。</p><p><code>exit_cb</code>で指定したcallback関数ではコマンド実行完了後に呼び出されるので、
<code>s:result</code>に格納した結果出力をバッファに出力する処理を実装しています。</p><div class=highlight><pre class=chroma><code class=language-vim data-lang=vim><span class=c>&#34; translate</span><span class=err>
</span><span class=err></span><span class=k>function</span><span class=p>!</span> <span class=nx>translate</span>#<span class=nx>translate</span><span class=p>(</span><span class=nx>bang</span><span class=p>,</span> <span class=nx>line1</span><span class=p>,</span> <span class=nx>line2</span><span class=p>,</span> ...<span class=p>)</span> <span class=nx>abort</span><span class=err>
</span><span class=err></span>    <span class=k>let</span> <span class=nx>ln</span> <span class=p>=</span> <span class=s2>&#34;\n&#34;</span><span class=err>
</span><span class=err></span>    <span class=k>if</span> &amp;<span class=nx>ff</span> <span class=p>==</span> <span class=s2>&#34;dos&#34;</span><span class=err>
</span><span class=err></span>        <span class=k>let</span> <span class=nx>ln</span> <span class=p>=</span> <span class=s2>&#34;\r\n&#34;</span><span class=err>
</span><span class=err></span>    <span class=k>endif</span><span class=err>
</span><span class=err>
</span><span class=err></span>    <span class=k>let</span> <span class=nx>s</span>:<span class=nx>result</span> <span class=p>=</span> []<span class=err>
</span><span class=err></span>    <span class=k>let</span> <span class=nx>start</span> <span class=p>=</span> <span class=nx>a</span>:<span class=nx>line1</span><span class=err>
</span><span class=err></span>    <span class=k>let</span> <span class=nx>end</span> <span class=p>=</span> <span class=nx>a</span>:<span class=nx>line2</span><span class=err>
</span><span class=err>
</span><span class=err></span>    <span class=k>if</span> <span class=nx>s</span>:<span class=nx>current_mode</span> <span class=p>==</span> <span class=nx>s</span>:<span class=nx>real_time_mode</span><span class=err>
</span><span class=err></span>        <span class=k>let</span> <span class=nx>start</span> <span class=p>=</span> <span class=m>1</span><span class=err>
</span><span class=err></span>        <span class=k>let</span> <span class=nx>end</span> <span class=p>=</span> <span class=nx>getpos</span><span class=p>(</span><span class=s2>&#34;$&#34;</span><span class=p>)</span>[<span class=m>1</span>]<span class=err>
</span><span class=err></span>        <span class=k>let</span> <span class=nx>cmd</span> <span class=p>=</span> <span class=nx>s</span>:<span class=nx>create_cmd</span><span class=p>(</span><span class=nx>s</span>:<span class=nx>getline</span><span class=p>(</span><span class=nx>start</span><span class=p>,</span> <span class=nx>end</span><span class=p>,</span> <span class=nx>ln</span><span class=p>,</span> <span class=nx>a</span>:<span class=m>000</span><span class=p>),</span> <span class=nx>s</span>:<span class=nx>bang</span><span class=p>)</span><span class=err>
</span><span class=err></span>    <span class=k>else</span><span class=err>
</span><span class=err></span>        <span class=k>let</span> <span class=nx>cmd</span> <span class=p>=</span> <span class=nx>s</span>:<span class=nx>create_cmd</span><span class=p>(</span><span class=nx>s</span>:<span class=nx>getline</span><span class=p>(</span><span class=nx>start</span><span class=p>,</span> <span class=nx>end</span><span class=p>,</span> <span class=nx>ln</span><span class=p>,</span> <span class=nx>a</span>:<span class=m>000</span><span class=p>),</span> <span class=nx>a</span>:<span class=nx>bang</span><span class=p>)</span><span class=err>
</span><span class=err></span>    <span class=k>endif</span><span class=err>
</span><span class=err>
</span><span class=err></span>    <span class=nx>echo</span> <span class=s2>&#34;Translating...&#34;</span><span class=err>
</span><span class=err></span>    <span class=k>let</span> <span class=nx>job</span> <span class=p>=</span> <span class=nx>job_start</span><span class=p>(</span><span class=nx>cmd</span><span class=p>,</span> {<span class=err>
</span><span class=err></span>                \<span class=s2>&#34;callback&#34;</span>: <span class=k>function</span><span class=p>(</span><span class=s2>&#34;s:tran_out_cb&#34;</span><span class=p>),</span><span class=err>
</span><span class=err></span>                \<span class=s2>&#34;exit_cb&#34;</span>: <span class=k>function</span><span class=p>(</span><span class=s2>&#34;s:tran_exit_cb&#34;</span><span class=p>),</span><span class=err>
</span><span class=err></span>                \}<span class=p>)</span><span class=err>
</span><span class=err></span><span class=k>endfunction</span><span class=err>
</span><span class=err></span><span class=c>
</span><span class=c>&#34; get command result</span><span class=err>
</span><span class=err></span><span class=k>function</span><span class=p>!</span> <span class=nx>s</span>:<span class=nx>tran_out_cb</span><span class=p>(</span><span class=nx>ch</span><span class=p>,</span> <span class=nx>msg</span><span class=p>)</span> <span class=nx>abort</span><span class=err>
</span><span class=err></span>    <span class=nx>call</span> <span class=nx>add</span><span class=p>(</span><span class=nx>s</span>:<span class=nx>result</span><span class=p>,</span> <span class=nx>a</span>:<span class=nx>msg</span><span class=p>)</span><span class=err>
</span><span class=err></span><span class=k>endfunction</span><span class=err>
</span><span class=err></span><span class=c>
</span><span class=c>&#34; set command result to translate window buffer</span><span class=err>
</span><span class=err></span><span class=k>function</span><span class=p>!</span> <span class=nx>s</span>:<span class=nx>tran_exit_cb</span><span class=p>(</span><span class=nx>job</span><span class=p>,</span> <span class=nx>status</span><span class=p>)</span> <span class=nx>abort</span><span class=err>
</span><span class=err></span>    <span class=nx>call</span> <span class=nx>s</span>:<span class=nx>create_tran_window</span><span class=p>()</span><span class=err>
</span><span class=err></span>    <span class=nx>call</span> <span class=nx>setline</span><span class=p>(</span><span class=m>1</span><span class=p>,</span> <span class=nx>s</span>:<span class=nx>result</span><span class=p>)</span><span class=err>
</span><span class=err></span>    <span class=nx>call</span> <span class=nx>s</span>:<span class=nx>focus_window</span><span class=p>(</span><span class=nx>bufnr</span><span class=p>(</span><span class=nx>s</span>:<span class=nx>currentw</span><span class=p>))</span><span class=err>
</span><span class=err></span>    <span class=nx>echo</span> <span class=s2>&#34;&#34;</span><span class=err>
</span><span class=err></span><span class=k>endfunction</span><span class=err>
</span></code></pre></div><p>ざっくりですがプラグインが動く仕組みについて紹介しました。
もっと知りたい方はぜひソースを読んでみてください。
大したことしていないので読みやすいと思います。</p><h3 id=既知の問題点>既知の問題点<a href=#既知の問題点 class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p><a href=https://github.com/cohama/lexima.vim>lexima.vim</a>では<code>&lt;CR></code>のマッピングがあるので、
leximaが入っていると自動翻訳が動かなくなります。</p><p>この問題を修正する予定です。</p><h3 id=今後について>今後について<a href=#今後について class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>現在プラグインはVimのみ対応しているのでNeoVimでも動くようにしたいと考えています。
また、NeoVimで実装されたフロートウィンドウを使用して翻訳結果をポップアップウィンドウとして表示させ方がより便利かなと思っています。</p><h2 id=最後に>最後に<a href=#最後に class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>Vimを始めたてのころにセッション管理のプラグインを作ったことがありましたが、正直よくわかりませんでした。
はじめてちゃんとプラグインを作って、まだまだ知らないことがたくさんあるなぁと実感しました。</p><p>ただ、Vim scriptはbashと似ていて個人的にそんなにとっつきにくい印象はなく楽しかったです。</p><p>このきっかけに今後もプラグインをコツコツ作っていこうと思えました。</p><p>次のプラグインは<code>電車乗り換え乗案内.vim</code>を作ります。
乞うご期待！</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>Google Apps Script <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://skanehira.github.io/blog/tags/Vim>Vim</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2019/05/12 00:00</p></footer></article><aside id=toc><div class=toc-title></div><nav id=TableOfContents><ul><li><a href=#機能>機能</a><ul><li><a href=#動的に翻訳する>動的に翻訳する</a></li><li><a href=#選択した範囲を翻訳する>選択した範囲を翻訳する</a></li></ul></li><li><a href=#仕組み>仕組み</a><ul><li><a href=#翻訳api>翻訳API</a></li><li><a href=#翻訳cli>翻訳CLI</a></li><li><a href=#vimプラグイン>Vimプラグイン</a></li><li><a href=#既知の問題点>既知の問題点</a></li><li><a href=#今後について>今後について</a></li></ul></li><li><a href=#最後に>最後に</a></li></ul></nav></aside><div class="post-nav thin"><a class=next-post href=https://skanehira.github.io/blog/posts/20190520-vim-quick-manual/><span class=post-nav-label><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>&nbsp;</span><br><span>お勧めVimヘルプ</span></a>
<a class=prev-post href=https://skanehira.github.io/blog/posts/20190427-vim-help-jp/><span class=post-nav-label>&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>Vimヘルプを日本語化</span></a></div><div id=comments class=thin></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2021 <a href=https://skanehira.github.io/blog/>skanehira</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://skanehira.github.io/blog/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://skanehira.github.io/blog/js/bundle.min.4a9a0ac3d2217822c7865b4161e6c2a71de1d70492264337755427898dd718f6.js integrity="sha256-SpoKw9IheCLHhltBYebCpx3h1wSSJkM3dVQniY3XGPY=" crossorigin=anonymous></script></body></html>